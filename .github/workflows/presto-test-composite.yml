name: Presto Test Composite
description: Template for Presto jobs
on:
  workflow_call:
    inputs:
      velox_commit:
        description: 'Velox commit SHA or branch'
        type: string
        required: false
        default: 'main'
      presto_commit:
        description: 'Presto commit SHA or branch'
        type: string
        required: false
        default: 'master'
      presto_worker_type:
        description: 'Type of presto worker to use'
        type: string
      node_label:
        description: 'Node label to run on'
        type: string

jobs:
  runs-on: ${{ inputs.node_label }}
  steps:
    - name: Checkout velox-testing
      uses: actions/checkout@v4
      with:
        path: velox-testing
    - name: Checkout Velox
      uses: actions/checkout@v4
      with:
        repository: facebookincubator/velox
        ref: ${{ inputs.velox_commit }}
        path: velox
    - name: Checkout Presto
      uses: actions/checkout@v4
      with:
        repository: prestodb/presto
        ref: ${{ inputs.presto_commit }}
        path: presto
    - name: Build and run presto
      run: |
        pushd velox-testing/presto/scripts
        ./start_${{ github.event.inputs.presto_worker_type }}_presto.sh
        ./run_integ_test.sh -b tpch
        popd
    - name: Shutdown
      run: |
        pushd velox-testing/presto/scripts
        ./stop_presto.sh
        popd
