name: Presto Test Composite
description: Template for Presto jobs
on:
  workflow_call:
    inputs:
      presto_repository:
        description: 'Presto Repository'
        type: string
        required: false
        default: 'prestodb/presto'
      presto_commit:
        description: 'Presto Commit SHA or Branch'
        type: string
        required: false
        default: 'master'
      velox_repository:
        description: 'Velox Repository'
        type: string
        required: false
        default: 'facebookincubator/velox'
      velox_commit:
        description: 'Velox Commit SHA or Branch'
        type: string
        required: false
        default: 'main'
      velox_testing_commit:
        description: 'Velox Testing Commit SHA or Branch'
        type: string
        required: false
        default: 'main'
      presto_worker_type:
        description: 'Type of Presto Worker to use'
        type: string
        required: true
      node_label:
        description: 'Node Label to run on'
        type: string
        required: true

jobs:
  build-and-test:
    runs-on: ${{ inputs.node_label }}
    steps:
      - name: Checkout Presto
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.presto_repository }}
          ref: ${{ inputs.presto_commit }}
          path: presto
      - name: Checkout Velox
        if: ${{ inputs.presto_worker_type != 'java' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.velox_repository }}
          ref: ${{ inputs.velox_commit }}
          path: velox
      - name: Checkout Velox Testing
        uses: actions/checkout@v4
        with:
          repository: rapidsai/velox-testing
          ref: ${{ inputs.velox_testing_commit }}
          path: velox-testing
      - name: Configure S3 Credentials for Presto Dependencies Container Image download
        if: ${{ inputs.presto_worker_type != 'java' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1
      - name: Ensure Presto Dependencies Container Image is downloaded or built
        if: ${{ inputs.presto_worker_type != 'java' }}
        run: |
          pushd velox-testing/presto/scripts
          ./build_centos_deps_image.sh
          popd
      - name: Build Presto
        run: |
          pushd velox-testing/presto/scripts
          ./start_${{ inputs.presto_worker_type }}_presto.sh
          popd
      - name: Run Integration Tests
        run: |
          pushd velox-testing/presto/scripts
          ./run_integ_test.sh -b tpch
          popd
      - name: Shutdown Presto
        run: |
          pushd velox-testing/presto/scripts
          ./stop_presto.sh
          popd
