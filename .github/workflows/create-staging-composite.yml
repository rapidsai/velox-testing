name: Create Staging Branch (Reusable)

on:
  workflow_call:
    inputs:
      base_repository:
        description: 'Base repository (e.g., facebookincubator/velox)'
        type: string
        required: true
      base_branch:
        description: 'Base branch to sync from'
        type: string
        required: true
      target_repository:
        description: 'Target repository (e.g., rapidsai/velox)'
        type: string
        required: true
      target_branch:
        description: 'Target branch name'
        type: string
        required: true
        default: 'staging'
      auto_fetch_prs:
        description: 'Auto-fetch non-draft PRs with specified label'
        type: boolean
        required: false
        default: true
      pr_labels:
        description: 'Comma-separated PR labels to auto-fetch'
        type: string
        required: false
        default: ''
      manual_pr_numbers:
        description: 'Comma-separated PR numbers to merge'
        type: string
        required: false
        default: ''
      exclude_pr_numbers:
        description: 'Comma-separated PR numbers to exclude from auto-fetch results'
        type: string
        required: false
        default: ''
      force_push:
        description: 'Force push to target branch'
        type: boolean
        required: false
        default: false
      additional_repository:
        description: 'Additional repository to merge from'
        type: string
        required: false
        default: ''
      additional_branch:
        description: 'Branch from additional repository to merge'
        type: string
        required: false
        default: ''
      script_path:
        description: 'Path to the staging script (e.g., ./velox-testing/velox/scripts/create_staging.sh)'
        type: string
        required: true
    secrets:
      fork_pat:
        description: 'GitHub PAT for target repository'
        required: true
    outputs:
      staging_repository:
        description: 'Target repository for the staging branch'
        value: ${{ jobs.create-staging.outputs.staging_repository }}
      staging_branch:
        description: 'Target staging branch name'
        value: ${{ jobs.create-staging.outputs.staging_branch }}
      staging_commit:
        description: 'Commit SHA of the staging branch HEAD'
        value: ${{ jobs.create-staging.outputs.staging_commit }}

jobs:
  create-staging:
    runs-on: linux-amd64-cpu4
    permissions:
      contents: write
    outputs:
      staging_repository: ${{ steps.staging-info.outputs.staging_repository }}
      staging_branch: ${{ steps.staging-info.outputs.staging_branch }}
      staging_commit: ${{ steps.staging-info.outputs.staging_commit }}
    env:
      GH_TOKEN: ${{ secrets.fork_pat }}
      TARGET_REPO: ${{ inputs.target_repository }}
      SCRIPT_PATH: ${{ inputs.script_path }}
      BASE_ARGS: >-
        --mode ci
        --base-repository ${{ inputs.base_repository }}
        --base-branch ${{ inputs.base_branch }}
        --target-branch ${{ inputs.target_branch }}
        --auto-fetch-prs ${{ inputs.auto_fetch_prs }}
        ${{ inputs.pr_labels && format('--pr-labels {0}', inputs.pr_labels) || '' }}
        ${{ inputs.manual_pr_numbers && format('--manual-pr-numbers {0}', inputs.manual_pr_numbers) || '' }}
        ${{ inputs.exclude_pr_numbers && format('--exclude-pr-numbers {0}', inputs.exclude_pr_numbers) || '' }}
        ${{ inputs.additional_repository && format('--additional-repository {0}', inputs.additional_repository) || '' }}
        ${{ inputs.additional_branch && format('--additional-branch {0}', inputs.additional_branch) || '' }}
        --force-push ${{ inputs.force_push }}
    steps:
      - name: ðŸ“¦ Checkout velox-testing
        uses: actions/checkout@v4
        with:
          path: velox-testing

      - name: âš™ï¸ Setup Git Configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“¥ Clone target repository
        run: |
          # Extract project name from script path (e.g., velox from ./velox-testing/velox/scripts/...)
          TARGET_DIR=$(echo "${SCRIPT_PATH}" | sed 's|.*/velox-testing/||' | cut -d'/' -f1)
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git" "${TARGET_DIR}"

      - name: ðŸ”„ Reset target branch
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step reset

      - name: ðŸ”— Merge additional repository/branch
        if: ${{ inputs.additional_repository != '' && inputs.additional_branch != '' }}
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step merge-additional

      - name: ðŸ“‹ Fetch PR list
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step fetch-prs

      - name: ðŸ§ª Test merge compatibility
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-merge

      - name: ðŸ§ª Test pairwise merge compatibility
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-pairwise

      - name: ðŸ”€ Merge PRs
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step merge

      - name: ðŸ“ Create staging manifest
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step manifest

      - name: ðŸš€ Push branches
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step push

      - name: ðŸ“Œ Capture staging outputs
        id: staging-info
        run: |
          TARGET_DIR=$(echo "${SCRIPT_PATH}" | sed 's|.*/velox-testing/||' | cut -d'/' -f1)
          echo "staging_repository=${TARGET_REPO}" >> "${GITHUB_OUTPUT}"
          echo "staging_branch=${{ inputs.target_branch }}" >> "${GITHUB_OUTPUT}"
          echo "staging_commit=$(git -C "${TARGET_DIR}" rev-parse HEAD)" >> "${GITHUB_OUTPUT}"
