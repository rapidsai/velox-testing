name: Create Staging Branch (Reusable)

on:
  workflow_call:
    inputs:
      base_repository:
        description: 'Base repository (e.g., facebookincubator/velox)'
        type: string
        required: true
      base_branch:
        description: 'Base branch to sync from'
        type: string
        required: true
      target_repository:
        description: 'Target repository (e.g., rapidsai/velox)'
        type: string
        required: true
      target_branch:
        description: 'Target branch name'
        type: string
        required: true
        default: 'staging'
      auto_fetch_prs:
        description: 'Auto-fetch non-draft PRs with specified label'
        type: boolean
        required: false
        default: true
      pr_labels:
        description: 'Comma-separated PR labels to auto-fetch'
        type: string
        required: false
        default: ''
      manual_pr_numbers:
        description: 'Comma-separated PR numbers to merge'
        type: string
        required: false
        default: ''
      exclude_pr_numbers:
        description: 'Comma-separated PR numbers to exclude from auto-fetch results'
        type: string
        required: false
        default: ''
      force_push:
        description: 'Force push to target branch'
        type: boolean
        required: false
        default: false
      additional_repository:
        description: 'Additional repository to merge from'
        type: string
        required: false
        default: ''
      additional_branch:
        description: 'Branch from additional repository to merge'
        type: string
        required: false
        default: ''
      script_path:
        description: 'Path to the staging script (e.g., ./velox-testing/velox/scripts/create_staging.sh)'
        type: string
        required: true
    secrets:
      fork_pat:
        description: 'GitHub PAT for target repository'
        required: true

jobs:
  create-staging:
    runs-on: linux-amd64-cpu4
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.fork_pat }}
      TARGET_REPO: ${{ inputs.target_repository }}
      SCRIPT_PATH: ${{ inputs.script_path }}
      BASE_ARGS: >-
        --mode ci
        --base-repository ${{ inputs.base_repository }}
        --base-branch ${{ inputs.base_branch }}
        --target-branch ${{ inputs.target_branch }}
        --auto-fetch-prs ${{ inputs.auto_fetch_prs }}
        ${{ inputs.pr_labels && format('--pr-labels {0}', inputs.pr_labels) || '' }}
        ${{ inputs.manual_pr_numbers && format('--manual-pr-numbers {0}', inputs.manual_pr_numbers) || '' }}
        ${{ inputs.exclude_pr_numbers && format('--exclude-pr-numbers {0}', inputs.exclude_pr_numbers) || '' }}
        ${{ inputs.additional_repository && format('--additional-repository {0}', inputs.additional_repository) || '' }}
        ${{ inputs.additional_branch && format('--additional-branch {0}', inputs.additional_branch) || '' }}
        --force-push ${{ inputs.force_push }}
    steps:
      - name: ğŸ“¦ Checkout velox-testing
        uses: actions/checkout@v4
        with:
          path: velox-testing

      - name: âš™ï¸ Setup Git Configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¥ Clone target repository
        run: |
          # Extract project name from script path (e.g., velox from ./velox-testing/velox/scripts/...)
          TARGET_DIR=$(echo "${SCRIPT_PATH}" | sed 's|.*/velox-testing/||' | cut -d'/' -f1)
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git" "${TARGET_DIR}"

      - name: ğŸ”„ Reset target branch
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step reset

      - name: ğŸ§ª Test base branch compatibility
        id: test_bases
        continue-on-error: true
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-bases

      - name: ğŸ“‹ Fetch PR list
        id: fetch_prs
        continue-on-error: true
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step fetch-prs

      - name: ğŸ§ª Test merge compatibility
        id: test_merge
        continue-on-error: true
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-merge

      - name: ğŸ§ª Test merge compatibility (merged bases)
        id: test_merge_merged_bases
        continue-on-error: true
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-merge-merged-bases

      - name: ğŸ§ª Test pairwise merge compatibility
        id: test_pairwise
        continue-on-error: true
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-pairwise

      - name: ğŸ§ª Test pairwise merge compatibility (merged bases)
        id: test_pairwise_merged_bases
        continue-on-error: true
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step test-pairwise-merged-bases

      - name: âŒ Fail if any test step failed
        if: ${{ always() }}
        run: |
          if [[ "${{ steps.test_bases.outcome }}" == "failure" ||
                "${{ steps.fetch_prs.outcome }}" == "failure" ||
                "${{ steps.test_merge.outcome }}" == "failure" ||
                "${{ steps.test_merge_merged_bases.outcome }}" == "failure" ||
                "${{ steps.test_pairwise.outcome }}" == "failure" ||
                "${{ steps.test_pairwise_merged_bases.outcome }}" == "failure" ]]; then
            echo "One or more staging test steps failed."
            exit 1
          fi

      - name: ğŸ”— Merge additional repository/branch
        if: ${{ inputs.additional_repository != '' && inputs.additional_branch != '' }}
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step merge-additional

      - name: ğŸ”€ Merge PRs
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step merge

      - name: ğŸ“ Create staging manifest
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step manifest

      - name: ğŸš€ Push branches
        run: ${SCRIPT_PATH} ${BASE_ARGS} --step push
