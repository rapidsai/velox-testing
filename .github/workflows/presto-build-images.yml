name: Presto Build Docker Images
description: Build Presto coordinator and worker images and store them as artifacts

on:
  workflow_dispatch:
    inputs:
      presto_repository:
        description: 'Presto repository to clone'
        type: string
        required: false
        default: 'prestodb/presto'
      presto_commit:
        description: 'Presto commit SHA or branch to build'
        type: string
        required: false
        default: 'master'
      velox_repository:
        description: 'Velox repository to clone'
        type: string
        required: false
        default: 'facebookincubator/velox'
      velox_commit:
        description: 'Velox commit SHA or branch to build'
        type: string
        required: false
        default: 'main'
      worker_variant:
        description: 'Presto worker variant to build'
        type: choice
        options:
          - native_cpu
          - native_gpu
          - java
        default: native_cpu
      worker_bundle_mode:
        description: 'Optional bundle mode to build multiple worker variants'
        type: choice
        options:
          - single
          - all
          - all_native
        default: single
      set_velox_backward_compatible:
        description: 'Define VELOX_ENABLE_BACKWARD_COMPATIBILITY when building native workers'
        type: boolean
        default: false
      target_platform:
        description: 'Docker platform/architecture for image builds'
        type: choice
        options:
          - linux/amd64
          - linux/arm64
        default: linux/amd64
      runner_label:
        description: 'Runner label (encodes architecture/capacity)'
        type: string
        required: false
        default: 'linux-amd64-cpu16'

jobs:
  build-and-package:
    name: Build and package docker images
    runs-on: ${{ github.event.inputs.runner_label || 'linux-amd64-cpu16' }}
    env:
      PRESTO_REF: ${{ github.event.inputs.presto_commit || 'master' }}
      VELOX_REF: ${{ github.event.inputs.velox_commit || 'main' }}
      PRESTO_REPOSITORY: ${{ github.event.inputs.presto_repository || 'prestodb/presto' }}
      VELOX_REPOSITORY: ${{ github.event.inputs.velox_repository || 'facebookincubator/velox' }}
      TARGET_PLATFORM: ${{ github.event.inputs.target_platform || 'linux/amd64' }}
      WORKER_VARIANT: ${{ github.event.inputs.worker_variant || 'native_cpu' }}
      WORKER_BUNDLE_MODE: ${{ github.event.inputs.worker_bundle_mode || 'single' }}
      SET_VELOX_BACKWARD_COMPATIBLE: ${{ github.event.inputs.set_velox_backward_compatible || 'false' }}
      ARTIFACT_DIR: ${{ github.workspace }}/artifacts
      REGISTRY_HOST: ${{ vars.GITLAB_REGISTRY_HOST || 'gitlab-master.nvidia.com:5005' }}
      REGISTRY_NAMESPACE: ${{ vars.GITLAB_REGISTRY_NAMESPACE || 'hercules/veloxtesting' }}
      REGISTRY_PUSH_ENABLED: 'false'
    steps:
      - name: Checkout velox-testing
        uses: actions/checkout@v4
        with:
          path: velox-testing
          fetch-depth: 0

      - name: Checkout Presto
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRESTO_REPOSITORY }}
          ref: ${{ env.PRESTO_REF }}
          path: presto
          fetch-depth: 0
          submodules: recursive

      - name: Checkout Velox
        if: ${{ env.WORKER_VARIANT != 'java' || env.WORKER_BUNDLE_MODE == 'all' || env.WORKER_BUNDLE_MODE == 'all_native' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ env.VELOX_REPOSITORY }}
          ref: ${{ env.VELOX_REF }}
          path: velox
          fetch-depth: 0
          submodules: recursive

      - name: Ensure artifact directory
        shell: bash
        run: |
          mkdir -p "${ARTIFACT_DIR}"

      - name: Configure registry publishing
        shell: bash
        env:
          REGISTRY_USER: ${{ secrets.GITLAB_REGISTRY_USER }}
          REGISTRY_TOKEN: ${{ secrets.GITLAB_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -n "${REGISTRY_USER:-}" && -n "${REGISTRY_TOKEN:-}" ]]; then
            registry_host="${REGISTRY_HOST%/}"
            namespace="${REGISTRY_NAMESPACE#/}"
            echo "REGISTRY_PUSH_ENABLED=true" >> "${GITHUB_ENV}"
            echo "REGISTRY_PREFIX=${registry_host}/${namespace}" >> "${GITHUB_ENV}"
          else
            echo "REGISTRY_PUSH_ENABLED=false" >> "${GITHUB_ENV}"
            echo "REGISTRY_PREFIX=" >> "${GITHUB_ENV}"
          fi

      - name: Login to GitLab registry
        if: ${{ env.REGISTRY_PUSH_ENABLED == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ secrets.GITLAB_REGISTRY_USER }}
          password: ${{ secrets.GITLAB_REGISTRY_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare build metadata
        shell: bash
        run: |
          set -euo pipefail
          sanitize() {
            echo "${1}" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9_.-' '-'
          }
          presto_safe=$(sanitize "${PRESTO_REF:-unknown}")
          velox_safe=$(sanitize "${VELOX_REF:-unknown}")
          platform_raw="${TARGET_PLATFORM:-unknown}"
          platform_safe=$(echo "${platform_raw}" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          presto_short="${presto_safe:0:12}"
          velox_short="${velox_safe:0:12}"
          image_tag="presto-${presto_short}-velox-${velox_short}-${platform_safe}"
          artifact_dir="${GITHUB_WORKSPACE}/artifacts"
          echo "IMAGE_TAG=${image_tag}" >> "${GITHUB_ENV}"
          echo "ARTIFACT_DIR=${artifact_dir}" >> "${GITHUB_ENV}"
          mkdir -p "${artifact_dir}"

      - name: Determine worker build plan
        shell: bash
        run: |
          set -euo pipefail
          mode="${WORKER_BUNDLE_MODE:-single}"
          build_native_cpu=false
          build_native_gpu=false
          build_java=false
          case "${mode}" in
            all)
              build_native_cpu=true
              build_native_gpu=true
              build_java=true
              ;;
            all_native)
              build_native_cpu=true
              build_native_gpu=true
              ;;
            *)
              case "${WORKER_VARIANT:-native_cpu}" in
                native_cpu)
                  build_native_cpu=true
                  ;;
                native_gpu)
                  build_native_gpu=true
                  ;;
                java)
                  build_java=true
                  ;;
              esac
              ;;
          esac
          needs_native="false"
          if [[ "${build_native_cpu}" == "true" || "${build_native_gpu}" == "true" ]]; then
            needs_native="true"
          fi
          echo "BUILD_NATIVE_CPU=${build_native_cpu}" >> "${GITHUB_ENV}"
          echo "BUILD_NATIVE_GPU=${build_native_gpu}" >> "${GITHUB_ENV}"
          echo "BUILD_JAVA=${build_java}" >> "${GITHUB_ENV}"
          echo "NEEDS_NATIVE=${needs_native}" >> "${GITHUB_ENV}"
          echo "WORKER_PLAN=${mode}" >> "${GITHUB_ENV}"

      - name: Record build metadata
        shell: bash
        run: |
          set -euo pipefail
          cat <<EOF | tee "${ARTIFACT_DIR}/build-metadata.txt"
Presto repository : ${PRESTO_REPOSITORY}
Presto ref         : ${PRESTO_REF}
Velox repository   : ${VELOX_REPOSITORY}
Velox ref          : ${VELOX_REF}
Target platform    : ${TARGET_PLATFORM}
Worker bundle mode : ${WORKER_PLAN}
Build native CPU   : ${BUILD_NATIVE_CPU}
Build native GPU   : ${BUILD_NATIVE_GPU}
Build Java worker  : ${BUILD_JAVA}
Image tag          : ${IMAGE_TAG}
Registry push      : ${REGISTRY_PUSH_ENABLED}
Generated at       : $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF

      - name: Fetch Presto dependency image
        if: ${{ env.NEEDS_NATIVE == 'true' }}
        env:
          AWS_ARN_STRING: ${{ secrets.AWS_ARN_STRING }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          S3_BUCKET_REGION: ${{ vars.S3_BUCKET_REGION }}
        shell: bash
        run: |
          set -euo pipefail
          pushd velox-testing/presto/scripts >/dev/null
          ./fetch_centos_deps_image.sh
          popd >/dev/null

      - name: Enable Velox backward compatibility flag
        if: ${{ env.NEEDS_NATIVE == 'true' && env.SET_VELOX_BACKWARD_COMPATIBLE == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          pushd presto/presto-native-execution >/dev/null
          if ! grep -q "VELOX_ENABLE_BACKWARD_COMPATIBILITY" CMakeLists.txt; then
            sed -i 's/add_subdirectory(presto_cpp)/add_definitions(-DVELOX_ENABLE_BACKWARD_COMPATIBILITY)\nadd_subdirectory(presto_cpp)/' CMakeLists.txt
          fi
          popd >/dev/null

      - name: Build Presto Java distribution
        shell: bash
        run: |
          set -euo pipefail
          pushd velox-testing/presto/scripts >/dev/null
          PRESTO_VERSION="${PRESTO_REF}" ./build_presto_java_package.sh
          popd >/dev/null

      - name: Build Presto coordinator image
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          docker build \
            --progress plain \
            --platform ${TARGET_PLATFORM} \
            --file presto/docker/Dockerfile \
            --build-arg PRESTO_VERSION="${PRESTO_REF}" \
            --tag presto-coordinator:latest \
            --tag presto-coordinator:${IMAGE_TAG} \
            --tag presto-java-base:${IMAGE_TAG} \
            presto/docker
          docker tag presto-coordinator:${IMAGE_TAG} presto-java-worker:${IMAGE_TAG}
          docker tag presto-coordinator:latest presto-java-worker:latest
          if [[ "${REGISTRY_PUSH_ENABLED}" != "true" ]]; then
            echo "Saving coordinator image to ${ARTIFACT_DIR}/presto-coordinator-${IMAGE_TAG}.tar.gz (this may take several minutes)..."
            time docker save presto-coordinator:${IMAGE_TAG} | gzip -9 > "${ARTIFACT_DIR}/presto-coordinator-${IMAGE_TAG}.tar.gz"
            ls -lh "${ARTIFACT_DIR}/presto-coordinator-${IMAGE_TAG}.tar.gz"
          else
            echo "Registry publishing enabled; skipping coordinator tarball export."
          fi

      - name: Push Presto coordinator image
        if: ${{ env.REGISTRY_PUSH_ENABLED == 'true' }}
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          docker tag presto-coordinator:${IMAGE_TAG} "${REGISTRY_PREFIX}/presto-coordinator:${IMAGE_TAG}"
          docker tag presto-coordinator:latest "${REGISTRY_PREFIX}/presto-coordinator:latest"
          docker push "${REGISTRY_PREFIX}/presto-coordinator:${IMAGE_TAG}"
          docker push "${REGISTRY_PREFIX}/presto-coordinator:latest"
          docker tag presto-java-worker:${IMAGE_TAG} "${REGISTRY_PREFIX}/presto-java-worker:${IMAGE_TAG}"
          docker tag presto-java-worker:latest "${REGISTRY_PREFIX}/presto-java-worker:latest"
          docker push "${REGISTRY_PREFIX}/presto-java-worker:${IMAGE_TAG}"
          docker push "${REGISTRY_PREFIX}/presto-java-worker:latest"

      - name: Archive Java worker image
        if: ${{ env.BUILD_JAVA == 'true' && env.REGISTRY_PUSH_ENABLED != 'true' }}
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          echo "Saving Java worker image to ${ARTIFACT_DIR}/presto-java-worker-${IMAGE_TAG}.tar.gz (this may take several minutes)..."
          time docker save presto-java-worker:${IMAGE_TAG} | gzip -9 > "${ARTIFACT_DIR}/presto-java-worker-${IMAGE_TAG}.tar.gz"
          ls -lh "${ARTIFACT_DIR}/presto-java-worker-${IMAGE_TAG}.tar.gz"

      - name: Build Presto native CPU worker image
        if: ${{ env.BUILD_NATIVE_CPU == 'true' }}
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          docker build \
            --progress plain \
            --platform ${TARGET_PLATFORM} \
            --file velox-testing/presto/docker/native_build.dockerfile \
            --build-arg GPU=OFF \
            --build-arg BUILD_TYPE=release \
            --build-arg NUM_THREADS="$(nproc)" \
            --build-arg CUDA_ARCHITECTURES="75;80;86;90;100;120" \
            --tag presto-native-worker-cpu:latest \
            --tag presto-native-worker-cpu:${IMAGE_TAG} \
            .
          if [[ "${REGISTRY_PUSH_ENABLED}" != "true" ]]; then
            echo "Saving native CPU worker image to ${ARTIFACT_DIR}/presto-native-worker-cpu-${IMAGE_TAG}.tar.gz (this may take several minutes)..."
            time docker save presto-native-worker-cpu:${IMAGE_TAG} | gzip -9 > "${ARTIFACT_DIR}/presto-native-worker-cpu-${IMAGE_TAG}.tar.gz"
            ls -lh "${ARTIFACT_DIR}/presto-native-worker-cpu-${IMAGE_TAG}.tar.gz"
          else
            echo "Registry publishing enabled; skipping native CPU worker tarball export."
          fi

      - name: Push Presto native CPU worker image
        if: ${{ env.BUILD_NATIVE_CPU == 'true' && env.REGISTRY_PUSH_ENABLED == 'true' }}
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          docker tag presto-native-worker-cpu:${IMAGE_TAG} "${REGISTRY_PREFIX}/presto-native-worker-cpu:${IMAGE_TAG}"
          docker tag presto-native-worker-cpu:latest "${REGISTRY_PREFIX}/presto-native-worker-cpu:latest"
          docker push "${REGISTRY_PREFIX}/presto-native-worker-cpu:${IMAGE_TAG}"
          docker push "${REGISTRY_PREFIX}/presto-native-worker-cpu:latest"

      - name: Build Presto native GPU worker image
        if: ${{ env.BUILD_NATIVE_GPU == 'true' }}
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          docker build \
            --progress plain \
            --platform ${TARGET_PLATFORM} \
            --file velox-testing/presto/docker/native_build.dockerfile \
            --build-arg GPU=ON \
            --build-arg BUILD_TYPE=release \
            --build-arg NUM_THREADS="$(nproc)" \
            --build-arg CUDA_ARCHITECTURES="75;80;86;90;100;120" \
            --tag presto-native-worker-gpu:latest \
            --tag presto-native-worker-gpu:${IMAGE_TAG} \
            .
          if [[ "${REGISTRY_PUSH_ENABLED}" != "true" ]]; then
            echo "Saving native GPU worker image to ${ARTIFACT_DIR}/presto-native-worker-gpu-${IMAGE_TAG}.tar.gz (this may take several minutes)..."
            time docker save presto-native-worker-gpu:${IMAGE_TAG} | gzip -9 > "${ARTIFACT_DIR}/presto-native-worker-gpu-${IMAGE_TAG}.tar.gz"
            ls -lh "${ARTIFACT_DIR}/presto-native-worker-gpu-${IMAGE_TAG}.tar.gz"
          else
            echo "Registry publishing enabled; skipping native GPU worker tarball export."
          fi

      - name: Push Presto native GPU worker image
        if: ${{ env.BUILD_NATIVE_GPU == 'true' && env.REGISTRY_PUSH_ENABLED == 'true' }}
        shell: bash
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          docker tag presto-native-worker-gpu:${IMAGE_TAG} "${REGISTRY_PREFIX}/presto-native-worker-gpu:${IMAGE_TAG}"
          docker tag presto-native-worker-gpu:latest "${REGISTRY_PREFIX}/presto-native-worker-gpu:latest"
          docker push "${REGISTRY_PREFIX}/presto-native-worker-gpu:${IMAGE_TAG}"
          docker push "${REGISTRY_PREFIX}/presto-native-worker-gpu:latest"

      - name: Upload docker image artifacts
        if: ${{ env.REGISTRY_PUSH_ENABLED != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: presto-images-${{ github.run_id }}
          path: ${{ env.ARTIFACT_DIR }}
          if-no-files-found: warn

