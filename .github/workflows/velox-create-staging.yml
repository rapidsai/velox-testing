name: Velox Create Staging Branch

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      base_repository:
        description: Base Velox repository
        type: string
        required: false
        default: 'facebookincubator/velox'
      base_branch:
        description: Base Velox branch
        type: string
        required: false
        default: 'main'
      target_repository:
        description: Target Velox repository
        type: string
        required: true
        default: 'rapidsai/velox'
      target_branch:
        description: Target Velox branch
        type: string
        required: true
        default: 'staging'
      auto_fetch_prs:
        description: Auto-fetch non-draft PRs with 'cudf' label (disable to manually specify PRs)
        type: boolean
        required: false
        default: true
      manual_pr_numbers:
        description: "Manual PR numbers to merge (space-separated, e.g., '12345 12346'). Only used when auto_fetch_prs is false."
        type: string
        required: false
        default: ''
      build_and_run_tests:
        description: Build and run tests on the target branch after update
        type: boolean
        required: false
        default: true
      force_push:
        description: Force push to override existing target branch (use with caution)
        type: boolean
        required: false
        default: false
  # schedule:
  #   # - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  sync-and-aggregate:
    runs-on: linux-amd64-cpu4
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.VELOX_FORK_PAT || secrets.GITHUB_TOKEN }}
      TARGET_REPO: ${{ inputs.target_repository }}
      BASE_REPO: ${{ inputs.base_repository }}
      BASE_BRANCH: ${{ inputs.base_branch }}
      TARGET_BRANCH: ${{ inputs.target_branch }}
      AUTO_FETCH_PRS: ${{ inputs.auto_fetch_prs }}
      MANUAL_PR_NUMBERS: ${{ inputs.manual_pr_numbers }}
      BUILD_AND_RUN_TESTS: ${{ inputs.build_and_run_tests }}
      FORCE_PUSH: ${{ inputs.force_push }}
      BUILD_TARGET: gpu
      SCRIPT_PATH: ./velox-testing/velox/scripts/create_staging_branch.sh
      BASE_ARGS: >-
        --mode ci
        --target-path "velox"
        --target-repository "${{ inputs.target_repository }}"
        --base-repository "${{ inputs.base_repository }}"
        --base-branch "${{ inputs.base_branch }}"
        --target-branch "${{ inputs.target_branch }}"
        --auto-fetch-prs "${{ inputs.auto_fetch_prs }}"
        --manual-pr-numbers "${{ inputs.manual_pr_numbers }}"
        --force-push "${{ inputs.force_push }}"
    steps:
      - name: ğŸ“¦ Checkout velox-testing
        uses: actions/checkout@v4
        with:
          path: velox-testing

      - name: âš™ï¸ Setup Git Configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¥ Clone target repository
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git" velox

      - name: ğŸ”„ Reset target branch
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step reset

      - name: ğŸ“‹ Fetch PR list
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step fetch-prs

      - name: ğŸ§ª Test merge compatibility
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step test-merge

      - name: ğŸ§ª Test pairwise merge compatibility
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step test-pairwise

      - name: ğŸ”€ Merge PRs
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step merge

      - name: ğŸ“ Create staging manifest
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step manifest

      - name: ğŸš€ Push branches
        run: |
          ${SCRIPT_PATH} ${BASE_ARGS} --step push

      - name: ğŸ§± Build Velox
        if: inputs.build_and_run_tests != false
        run: |
          ${SCRIPT_PATH} \
            ${BASE_ARGS} \
            --build-and-run-tests "${BUILD_AND_RUN_TESTS}" \
            --build-target "${BUILD_TARGET}" \
            --step build

      - name: ğŸ§ª Run Velox tests
        if: inputs.build_and_run_tests != false
        run: |
          ${SCRIPT_PATH} \
            ${BASE_ARGS} \
            --build-and-run-tests "${BUILD_AND_RUN_TESTS}" \
            --build-target "${BUILD_TARGET}" \
            --step test
