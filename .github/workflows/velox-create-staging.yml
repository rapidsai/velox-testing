name: Velox Create Staging Branch

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      base_repository:
        description: Base Velox repository
        type: string
        required: false
        default: 'facebookincubator/velox'
      base_branch:
        description: Base Velox branch
        type: string
        required: false
        default: 'main'
      target_repository:
        description: Target Velox repository
        type: string
        required: true
        default: 'rapidsai/velox'
      target_branch:
        description: Target Velox branch
        type: string
        required: true
        default: 'staging'
      auto_fetch_prs:
        description: Auto-fetch non-draft PRs with 'cudf' label (disable to manually specify PRs)
        type: boolean
        required: false
        default: true
      manual_pr_numbers:
        description: "Manual PR numbers to merge (space-separated, e.g., '12345 12346'). Only used when auto_fetch_prs is false."
        type: string
        required: false
        default: ''
      build_and_run_tests:
        description: Build and run tests on the target branch after update
        type: boolean
        required: false
        default: true
      force_push:
        description: Force push to override existing target branch (use with caution)
        type: boolean
        required: false
        default: false
  # schedule:
  #   # - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  sync-and-aggregate:
    runs-on: linux-amd64-cpu4
    permissions:
      contents: write
    steps:
      - name: üì¶ Checkout velox-testing
        uses: actions/checkout@v4
        with:
          path: velox-testing

      - name: üîß Download gha-tools
        run: |
          git clone https://github.com/rapidsai/gha-tools.git -b main /tmp/gha-tools
          # Add gha-tools command-line scripts to PATH for subsequent steps
          echo "/tmp/gha-tools/tools" >> "${GITHUB_PATH}"

      - name: ‚öôÔ∏è Setup Git Configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: üì• Clone Target Repository and Setup Remotes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ inputs.target_repository }}
          BASE_REPO: ${{ inputs.base_repository }}
          BASE_BRANCH: ${{ inputs.base_branch }}
        run: |
          rapids-echo-stderr "Cloning ${TARGET_REPO}..."
          rapids-retry git clone https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git velox
          cd velox
          git remote add upstream https://github.com/${BASE_REPO}.git
          rapids-echo-stderr "Fetching upstream ${BASE_BRANCH}..."
          rapids-retry git fetch upstream ${BASE_BRANCH}
          
          # Generate dated branch name and set as env var for later steps
          CURRENT_DATE=$(date -u +%m-%d-%Y)
          DATED_BRANCH="${{ inputs.target_branch }}_${CURRENT_DATE}"
          echo "DATED_BRANCH=${DATED_BRANCH}" >> $GITHUB_ENV
          rapids-echo-stderr "Dated branch will be: ${DATED_BRANCH}"

      - name: üîÑ Reset ${{ inputs.target_branch }} Branch to Upstream ${{ inputs.base_branch }}
        working-directory: velox
        run: |
          rapids-echo-stderr "Resetting ${{ inputs.target_branch }} branch to match upstream/${{ inputs.base_branch }}..."
          git checkout -B ${{ inputs.target_branch }} upstream/${{ inputs.base_branch }}
          BASE_COMMIT=$(git rev-parse HEAD)
          echo "BASE_COMMIT=${BASE_COMMIT}" >> $GITHUB_ENV
          rapids-echo-stderr "${{ inputs.target_branch }} branch reset to upstream/${{ inputs.base_branch }} at ${BASE_COMMIT}"

      - name: üîç Auto-fetch PRs with 'cudf' Label (non-draft)
        id: auto-fetch-prs
        if: inputs.auto_fetch_prs == true  # Defaults to true for scheduled runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          rapids-echo-stderr "Auto-fetch enabled. Scanning for non-draft PRs with 'cudf' label..."
          
          PR_LIST=$(rapids-retry --quiet gh pr list \
            --repo facebookincubator/velox \
            --label "cudf" \
            --state open \
            --json number,isDraft \
            --jq '.[] | select(.isDraft == false) | .number' | tr '\n' ' ' | xargs)

          if [ -z "$PR_LIST" ]; then
            rapids-echo-stderr "No non-draft PRs found with 'cudf' label."
            echo "pr_list=" >> $GITHUB_OUTPUT
            echo "has_prs=false" >> $GITHUB_OUTPUT
          else
            rapids-echo-stderr "Found PRs: $PR_LIST"
            echo "pr_list=$PR_LIST" >> $GITHUB_OUTPUT
            echo "has_prs=true" >> $GITHUB_OUTPUT
          fi

      - name: ‚úèÔ∏è Use Manual PR Numbers
        id: manual-prs
        if: inputs.auto_fetch_prs == false
        run: |  # This step is only executed if auto_fetch_prs is false
          # Trim whitespace from input
          MANUAL_PRS=$(echo "${{ inputs.manual_pr_numbers }}" | xargs)

          if [ -z "$MANUAL_PRS" ]; then
            rapids-echo-stderr "No manual PR numbers provided."
            echo "has_prs=false" >> $GITHUB_OUTPUT
            echo "pr_list=" >> $GITHUB_OUTPUT
          else
            rapids-echo-stderr "Auto-fetch disabled. Using manual PR numbers: $MANUAL_PRS"
            echo "pr_list=$MANUAL_PRS" >> $GITHUB_OUTPUT
            echo "has_prs=true" >> $GITHUB_OUTPUT
          fi

      - name: üìã Determine PR List to Process
        id: prs-to-process
        run: |
          if [ "${{ inputs.auto_fetch_prs }}" != "false" ]; then
            PR_LIST="${{ steps.auto-fetch-prs.outputs.pr_list }}"
            HAS_PRS="${{ steps.auto-fetch-prs.outputs.has_prs }}"
          else
            PR_LIST="${{ steps.manual-prs.outputs.pr_list }}"
            HAS_PRS="${{ steps.manual-prs.outputs.has_prs }}"
          fi
          PR_COUNT=$(echo $PR_LIST | wc -w)
          echo "pr_list=$PR_LIST" >> $GITHUB_OUTPUT
          echo "has_prs=${HAS_PRS:-false}" >> $GITHUB_OUTPUT
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          rapids-echo-stderr "PRs to process: $PR_LIST (count: $PR_COUNT)"

      - name: ‚ùå Exit if No PRs Found
        if: steps.prs-to-process.outputs.has_prs != 'true'
        run: |
          rapids-echo-stderr "No PRs found to merge. Exiting workflow."
          exit 1

      - name: üß™ Test PR Merge Compatibility with ${{ inputs.base_branch }}
        id: test-merge
        if: steps.prs-to-process.outputs.has_prs == 'true'
        working-directory: velox
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_LIST: ${{ steps.prs-to-process.outputs.pr_list }}
          BASE_REPO: ${{ inputs.base_repository }}
          BASE_BRANCH: ${{ inputs.base_branch }}
        run: |
            rapids-echo-stderr "Testing merge compatibility for each PR against $BASE_REPO/$BASE_BRANCH..."
            
            # Store the base commit to reset after each test
            BASE_COMMIT=$(git rev-parse HEAD)
            
            # Arrays to track results
            SUCCESSFUL_PRS=""
            CONFLICT_PRS=""
            
            for pr_num in $PR_LIST; do
              rapids-echo-stderr "Testing PR #$pr_num..."
              
              # Fetch the specific PR head
              rapids-retry git fetch upstream pull/$pr_num/head:pr-$pr_num
              
              # Try to merge (test only)
              if git merge --no-commit --no-ff pr-$pr_num 2>/dev/null; then
                SUCCESSFUL_PRS="$SUCCESSFUL_PRS $pr_num"
              else
                CONFLICT_PRS="$CONFLICT_PRS $pr_num"
              fi
              
              # Abort merge and reset to base for next test
              git merge --abort 2>/dev/null || true
              git reset --hard $BASE_COMMIT
              git clean -fd
            done
            
            # Print summary table
            echo ""
            rapids-echo-stderr "======================================"
            rapids-echo-stderr "   PR Merge Compatibility Report"
            rapids-echo-stderr "======================================"
            echo ""
            rapids-echo-stderr "$(printf "| %-12s | %-7s | %-6s |" "Base Branch" "PR NO" "Status")"
            rapids-echo-stderr "$(printf "|%s|%s|%s|" "--------------" "---------" "--------")"
            
            for pr_num in $SUCCESSFUL_PRS; do
              # Emoji is 2 cells wide, so use %-5s (5 chars = 3 spaces + 2-cell emoji = 6 visual)
              rapids-echo-stderr "$(printf "| %-12s | #%-6s | %-5s |" "${BASE_BRANCH}" "$pr_num" "‚úÖ")"
            done
            
            for pr_num in $CONFLICT_PRS; do
              rapids-echo-stderr "$(printf "| %-12s | #%-6s | %-5s |" "${BASE_BRANCH}" "$pr_num" "‚ùå")"
            done
            
            echo ""
            rapids-echo-stderr "======================================"
            rapids-echo-stderr "Successful: $(echo $SUCCESSFUL_PRS | wc -w) | Conflicts: $(echo $CONFLICT_PRS | wc -w)"
            rapids-echo-stderr "======================================"
            
            # Output results
            echo "successful_prs=$SUCCESSFUL_PRS" >> $GITHUB_OUTPUT
            echo "conflict_prs=$CONFLICT_PRS" >> $GITHUB_OUTPUT
            
            # Fail if any conflicts
            if [ -n "$(echo $CONFLICT_PRS | xargs)" ]; then
              rapids-echo-stderr ""
              rapids-echo-stderr "‚ùå Some PRs have merge conflicts with $BASE_BRANCH. Please resolve before proceeding."
              for pr_num in $CONFLICT_PRS; do
                rapids-echo-stderr "   PR #$pr_num: https://github.com/${BASE_REPO}/pull/$pr_num"
              done
              exit 1
            fi
            
            rapids-echo-stderr "‚úÖ All PRs can merge cleanly with $BASE_BRANCH."

      - name: üß™ Test Pairwise PR Merge Compatibility
        id: test-pairwise
        if: steps.prs-to-process.outputs.has_prs == 'true' && steps.prs-to-process.outputs.pr_count >= 2
        working-directory: velox
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_LIST: ${{ steps.prs-to-process.outputs.pr_list }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          BASE_REPO: ${{ inputs.base_repository }}
        run: |
          rapids-echo-stderr "Testing pairwise merge compatibility between PRs..."
          
          # Convert PR list to array
          PR_ARRAY=($PR_LIST)
          PR_COUNT=${#PR_ARRAY[@]}
          
          # Store the base commit to reset after each test
            BASE_COMMIT=$(git rev-parse HEAD)
            
            # Track pairwise results
            SUCCESSFUL_PAIRS=""
            CONFLICT_PAIRS=""
            
            # Test each pair of PRs
            for ((i=0; i<$PR_COUNT; i++)); do
              for ((j=i+1; j<$PR_COUNT; j++)); do
                PR1=${PR_ARRAY[$i]}
                PR2=${PR_ARRAY[$j]}
                
                rapids-echo-stderr "Testing PR #$PR1 + PR #$PR2..."
                
                # Reset to base
                git reset --hard $BASE_COMMIT
                git clean -fd
                
                # First merge PR1
                if ! git merge --no-edit pr-$PR1 2>/dev/null; then
                  # PR1 alone has conflict (shouldn't happen if base test passed)
                  git merge --abort 2>/dev/null || true
                  git reset --hard $BASE_COMMIT
                  CONFLICT_PAIRS="$CONFLICT_PAIRS ${PR1}+${PR2}"
                  continue
                fi
                
                # Then try to merge PR2 on top
                if git merge --no-commit --no-ff pr-$PR2 2>/dev/null; then
                  SUCCESSFUL_PAIRS="$SUCCESSFUL_PAIRS ${PR1}+${PR2}"
                else
                  CONFLICT_PAIRS="$CONFLICT_PAIRS ${PR1}+${PR2}"
                fi
                
                # Reset for next test
                git merge --abort 2>/dev/null || true
                git reset --hard $BASE_COMMIT
                git clean -fd
              done
            done
            
            # Build matrix lookup for results
            declare -A MATRIX
            for pair in $SUCCESSFUL_PAIRS; do
              MATRIX[$pair]="‚úÖ"
            done
            for pair in $CONFLICT_PAIRS; do
              MATRIX[$pair]="‚ùå"
            done
            
            # Print matrix table
            echo ""
            rapids-echo-stderr "==========================================="
            rapids-echo-stderr "  Pairwise PR Merge Compatibility Matrix"
            rapids-echo-stderr "==========================================="
            echo ""
            
            # Print header row
            HEADER=$(printf "%8s" "")
            for pr in "${PR_ARRAY[@]}"; do
              HEADER+=$(printf "%8s" "$pr")
            done
            rapids-echo-stderr "$HEADER"
            
            # Print each row
            # Note: Emojis are 2 visual cells wide, dashes are 1, so adjust padding
            for ((i=0; i<$PR_COUNT; i++)); do
              PR_I=${PR_ARRAY[$i]}
              ROW=$(printf "%8s" "$PR_I")
              
              for ((j=0; j<$PR_COUNT; j++)); do
                if [ $j -le $i ]; then
                  # Lower triangle and diagonal (emoji is 2 cells, so use %7s)
                  ROW+=$(printf "%7s" "‚ûñ")
                else
                  # Upper triangle - show result (emoji is 2 cells, so use %7s)
                  PR_J=${PR_ARRAY[$j]}
                  PAIR="${PR_I}+${PR_J}"
                  RESULT="${MATRIX[$PAIR]:-?}"
                  ROW+=$(printf "%7s" "$RESULT")
                fi
              done
              
              rapids-echo-stderr "$ROW"
            done
            
            echo ""
            rapids-echo-stderr "==========================================="
            rapids-echo-stderr "Successful: $(echo $SUCCESSFUL_PAIRS | wc -w) | Conflicts: $(echo $CONFLICT_PAIRS | wc -w)"
            rapids-echo-stderr "==========================================="
            
            # Print legend with PR details
            echo ""
            rapids-echo-stderr "Legend:"
            rapids-echo-stderr "------------------------------------------------------------"
            rapids-echo-stderr "$(printf "| %-7s | %-15s | %-40s | %-50s |" "PR #" "Author" "Title" "Link")"
            rapids-echo-stderr "$(printf "|%s|%s|%s|%s|" "---------" "-----------------" "------------------------------------------" "----------------------------------------------------")"
            
            for pr in "${PR_ARRAY[@]}"; do
              # Fetch PR details
              PR_AUTHOR=$(gh pr view $pr --json author --jq '.author.login' 2>/dev/null || echo "N/A")
              PR_TITLE=$(gh pr view $pr --json title --jq '.title' 2>/dev/null || echo "N/A")
              # Truncate title if too long
              if [ ${#PR_TITLE} -gt 40 ]; then
                PR_TITLE="${PR_TITLE:0:37}..."
              fi
              PR_LINK="https://github.com/${BASE_REPO}/pull/$pr"
              
              rapids-echo-stderr "$(printf "| #%-6s | %-15s | %-40s | %-50s |" "$pr" "$PR_AUTHOR" "$PR_TITLE" "$PR_LINK")"
            done
            
            rapids-echo-stderr "------------------------------------------------------------"
            echo ""
            
            # Output results
            echo "successful_pairs=$SUCCESSFUL_PAIRS" >> $GITHUB_OUTPUT
            echo "conflict_pairs=$CONFLICT_PAIRS" >> $GITHUB_OUTPUT
            
            # Fail if any pairwise conflicts
            if [ -n "$(echo $CONFLICT_PAIRS | xargs)" ]; then
              rapids-echo-stderr ""
              rapids-echo-stderr "‚ùå Some PR pairs have merge conflicts. Please resolve before proceeding."
              exit 1
            fi
            
            rapids-echo-stderr "‚úÖ All PR pairs can merge cleanly together."

      - name: üîÄ Filter and Merge cuDF PRs
        id: merge-prs
        if: steps.prs-to-process.outputs.has_prs == 'true'
        working-directory: velox
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_LIST: ${{ steps.prs-to-process.outputs.pr_list }}
          BASE_REPO: ${{ inputs.base_repository }}
        run: |
            rapids-echo-stderr "Processing PRs: $PR_LIST"
            MERGED_COUNT=0
            MERGED_PRS=""

            for pr_num in $PR_LIST; do
              rapids-echo-stderr " -> PR #$pr_num: Attempting merge..."
              
              # Fetch the specific PR head
              rapids-retry git fetch upstream pull/$pr_num/head:pr-$pr_num
              
              # Try to merge pr-$pr_num into staging - FAIL IMMEDIATELY on conflict
              if ! git merge pr-$pr_num --no-edit; then
                rapids-echo-stderr "‚ùå MERGE CONFLICT in PR #$pr_num!"
                rapids-echo-stderr "   PR URL: https://github.com/${BASE_REPO}/pull/$pr_num"
                rapids-echo-stderr "   Please resolve the conflict manually or remove this PR from the merge list."
                git merge --abort
                exit 1
              fi
              
              rapids-echo-stderr " -> ‚úÖ Merged PR #$pr_num successfully."
              MERGED_COUNT=$((MERGED_COUNT + 1))
              MERGED_PRS="$MERGED_PRS $pr_num"
            done

            rapids-echo-stderr "Summary: Merged $MERGED_COUNT PRs"
            
            # Output the list of successfully merged PRs
            echo "merged_prs=${MERGED_PRS}" >> $GITHUB_OUTPUT
            echo "merged_count=$MERGED_COUNT" >> $GITHUB_OUTPUT

      - name: üìù Create Staging Manifest
        working-directory: velox
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_REPO: ${{ inputs.base_repository }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          TARGET_REPO: ${{ inputs.target_repository }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          MERGED_PRS: ${{ steps.merge-prs.outputs.merged_prs }}
        run: |
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            MANIFEST_FILE=".staging-manifest.yaml"
            TEMPLATE_FILE="${GITHUB_WORKSPACE}/velox-testing/.github/templates/staging-manifest.yaml.template"
            
            rapids-echo-stderr "Creating staging manifest at ${MANIFEST_FILE}..."
            
            # Copy template and replace placeholders
            cp ${TEMPLATE_FILE} ${MANIFEST_FILE}
            sed -i "s|{{TIMESTAMP}}|${TIMESTAMP}|g" ${MANIFEST_FILE}
            sed -i "s|{{TARGET_REPO}}|${TARGET_REPO}|g" ${MANIFEST_FILE}
            sed -i "s|{{TARGET_BRANCH}}|${TARGET_BRANCH}|g" ${MANIFEST_FILE}
            sed -i "s|{{DATED_BRANCH}}|${DATED_BRANCH}|g" ${MANIFEST_FILE}
            sed -i "s|{{BASE_REPO}}|${BASE_REPO}|g" ${MANIFEST_FILE}
            sed -i "s|{{BASE_BRANCH}}|${BASE_BRANCH}|g" ${MANIFEST_FILE}
            sed -i "s|{{BASE_COMMIT}}|${BASE_COMMIT}|g" ${MANIFEST_FILE}
            
            # Add each PR with its details
            if [ -n "${MERGED_PRS}" ]; then
              for pr_num in ${MERGED_PRS}; do
                # Get PR commit SHA (the head of the PR branch we merged)
                PR_COMMIT=$(git rev-parse pr-${pr_num} 2>/dev/null || echo "unknown")
                PR_TITLE=$(gh pr view ${pr_num} --repo ${BASE_REPO} --json title --jq '.title' 2>/dev/null || echo "N/A")
                PR_AUTHOR=$(gh pr view ${pr_num} --repo ${BASE_REPO} --json author --jq '.author.login' 2>/dev/null || echo "N/A")
                
                # Escape special characters in title for YAML
                PR_TITLE_ESCAPED=$(echo "${PR_TITLE}" | sed 's/"/\\"/g')
                
                # Append PR entry with proper YAML indentation (2 spaces for list items)
                echo "  - number: ${pr_num}" >> ${MANIFEST_FILE}
                echo "    commit: \"${PR_COMMIT}\"" >> ${MANIFEST_FILE}
                echo "    author: \"${PR_AUTHOR}\"" >> ${MANIFEST_FILE}
                echo "    title: \"${PR_TITLE_ESCAPED}\"" >> ${MANIFEST_FILE}
                echo "    url: \"https://github.com/${BASE_REPO}/pull/${pr_num}\"" >> ${MANIFEST_FILE}
              done
            else
              echo "  []  # No PRs merged" >> ${MANIFEST_FILE}
            fi
            
            rapids-echo-stderr "Manifest contents:"
            cat ${MANIFEST_FILE}
            
            # Stage and commit the manifest
            git add ${MANIFEST_FILE}
            git commit -m "${TIMESTAMP}" -m "Staging branch manifest for ${DATED_BRANCH}"
            
            rapids-echo-stderr "‚úÖ Manifest committed."

      - name: üöÄ Push ${{ inputs.target_branch }} and ${{ env.DATED_BRANCH }}
        id: push-staging
        working-directory: velox
        env:
          FORCE_PUSH: ${{ inputs.force_push }}
          EVENT_NAME: ${{ github.event_name }}
          TARGET_REPO: ${{ inputs.target_repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            rapids-echo-stderr "Pushing ${{ inputs.target_branch }} and ${DATED_BRANCH} to ${TARGET_REPO}..."
            
            # For scheduled runs, always force push since we're resetting to upstream base
            # For manual dispatch, respect the force_push input (defaults to false)
            # Push both branches in a single command (same commit, more efficient)
            if [ "$EVENT_NAME" == "schedule" ] || [ "$FORCE_PUSH" == "true" ]; then
              rapids-echo-stderr "Force push enabled. Overwriting target branches..."
              rapids-retry git push origin \
                HEAD:${{ inputs.target_branch }} \
                HEAD:${DATED_BRANCH} \
                --force
            else
              rapids-echo-stderr "Force push disabled. Attempting normal push..."
              if ! rapids-retry git push origin \
                HEAD:${{ inputs.target_branch }} \
                HEAD:${DATED_BRANCH}; then
                rapids-echo-stderr "‚ùå Push failed! Target branch may have diverged."
                rapids-echo-stderr "   Enable 'force_push' to override, or manually resolve conflicts."
                exit 1
              fi
            fi
            
            FINAL_COMMIT=$(git rev-parse HEAD)
            rapids-echo-stderr "‚úÖ Done! Both branches updated successfully."
            rapids-echo-stderr "   - ${{ inputs.target_branch }}: ${FINAL_COMMIT}"
            rapids-echo-stderr "   - ${DATED_BRANCH}: ${FINAL_COMMIT}"
            echo "commit_sha=$FINAL_COMMIT" >> $GITHUB_OUTPUT
            echo "dated_branch=${DATED_BRANCH}" >> $GITHUB_OUTPUT

    outputs:
      staging_commit: ${{ steps.push-staging.outputs.commit_sha }}

  # Build and run tests on the updated staging branch
  build-and-run-tests:
    needs: sync-and-aggregate
    if: inputs.build_and_run_tests != false  # Defaults to true for scheduled runs
    uses: ./.github/workflows/velox-test.yml
    with:
      repository: ${{ inputs.target_repository }}
      velox_commit: ${{ inputs.target_branch }}
      build_target: 'gpu'
    secrets: inherit
