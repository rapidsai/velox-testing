#!/bin/bash

set -e

function install_miniforge3() {
  echo "Install miniforge3..."
  trap "rm -rf temp_install" RETURN

  mkdir temp_install
  pushd temp_install
  curl -L -O "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
  bash Miniforge3-$(uname)-$(uname -m).sh -p "$MINIFORGE_HOME"
  popd
  echo "miniforge3 installation completed"
}

# Based on the script generated by `conda init bash`
function init_conda() {
  echo "Initializing conda.."
  __conda_setup=$($MINIFORGE_HOME/bin/conda 'shell.bash' 'hook')
  if [ $? -eq 0 ]; then
    eval "$__conda_setup"
  else
    if [ -f "$MINIFORGE_HOME/etc/profile.d/conda.sh" ]; then
      . "$MINIFORGE_HOME/etc/profile.d/conda.sh"
    else
      export PATH="$MINIFORGE_HOME/bin:$PATH"
    fi
  fi
  unset __conda_setup
  echo "Conda initialization completed"
}

function init_python_virtual_env() {
  rm -rf .venv

  if python3 -m venv .venv &>/dev/null; then
    echo "Created virtual environment using the venv module"

    echo "Activating venv environment"
    source .venv/bin/activate
  else
    if [[ -z $MINIFORGE_HOME ]]; then
        echo "Error: MINIFORGE_HOME must be set when attempting to create a virtual environment with conda"
        exit 1
    fi

    CONDA_BIN=$MINIFORGE_HOME/bin/conda
    if [[ ! -x "$CONDA_BIN" ]]; then
        install_miniforge3
    fi

    init_conda

    echo "Creating virtual environment using conda"
    conda create -q -y --prefix ".venv" python=3.12 > /dev/null

    echo "Activating conda environment"
    conda activate "$(readlink -f .venv)"
  fi
}

function delete_python_virtual_env() {
  if python3 -m venv --help &> /dev/null; then
    if command -v deactivate &> /dev/null; then
      echo "Deactivating venv environment"
      deactivate
    fi
  else
    if command -v conda &> /dev/null; then
      echo "Deactivating conda environment"
      conda deactivate
    fi
  fi

  echo "Deleting .venv directory"
  rm -rf .venv
}
