#!/bin/bash
# Run CMake configuration only for velox (useful for IDE integration)
# Usage: configure-velox [--release|--debug]

set -euo pipefail

# Defaults
BUILD_TYPE="${BUILD_TYPE:-release}"
BUILD_BASE_DIR="${BUILD_BASE_DIR:-/opt/velox-build}"

usage() {
    cat <<EOF
Usage: configure-velox [OPTIONS]

Run CMake configuration for velox without building.
Useful for IDE integration (CMake Tools, clangd, etc.)

Options:
  --release         Configure for release build (default)
  --debug           Configure for debug build
  -h, --help        Show this help message

Environment variables:
  BUILD_TYPE        release or debug
  BUILD_BASE_DIR    Base directory for build output (default: /opt/velox-build)
  CUDAARCHS         CUDA architectures (default: RAPIDS)
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --release) BUILD_TYPE="release"; shift ;;
        --debug) BUILD_TYPE="debug"; shift ;;
        -h|--help) usage; exit 0 ;;
        *) echo "Unknown option: $1"; usage; exit 1 ;;
    esac
done

VELOX_DIR="${HOME}/velox"
if [[ ! -d "${VELOX_DIR}" ]]; then
    echo "Error: velox repository not found at ${VELOX_DIR}"
    echo "Please ensure velox is mounted as a sibling directory."
    exit 1
fi

cd "${VELOX_DIR}"

echo "=== Configuring Velox ==="
echo "Build type:    ${BUILD_TYPE}"
echo "CUDA archs:    ${CUDAARCHS:-RAPIDS}"
echo "Build dir:     ${BUILD_BASE_DIR}/${BUILD_TYPE}"
echo ""

# Enable sccache if available
export CMAKE_C_COMPILER_LAUNCHER="${CMAKE_C_COMPILER_LAUNCHER:-sccache}"
export CMAKE_CXX_COMPILER_LAUNCHER="${CMAKE_CXX_COMPILER_LAUNCHER:-sccache}"
export CMAKE_CUDA_COMPILER_LAUNCHER="${CMAKE_CUDA_COMPILER_LAUNCHER:-sccache}"

# Build CMake flags
EXTRA_CMAKE_FLAGS="-DVELOX_ENABLE_CUDF=ON"
EXTRA_CMAKE_FLAGS+=" -DVELOX_ENABLE_ARROW=ON"
EXTRA_CMAKE_FLAGS+=" -DVELOX_ENABLE_PARQUET=ON"
EXTRA_CMAKE_FLAGS+=" -DVELOX_MONO_LIBRARY=ON"
EXTRA_CMAKE_FLAGS+=" -DVELOX_BUILD_SHARED=ON"

# Auto-detect RAPIDS library paths from rapids-build-utils if available
# This allows velox to find cudf, rmm, kvikio built by the RAPIDS build system
get_rapids_cmake_dir() {
    local lib_name="$1"
    local repo_path="${HOME}/${lib_name}"

    if command -v rapids-get-cmake-build-dir &>/dev/null && [[ -d "${repo_path}" ]]; then
        local build_dir
        build_dir=$(rapids-get-cmake-build-dir "${repo_path}/cpp" 2>/dev/null || true)
        if [[ -n "${build_dir}" && -d "${build_dir}" ]]; then
            echo "${build_dir}"
        fi
    fi
}

# Add RAPIDS dependency paths
# Check for cudf
CUDF_BUILD_DIR=$(get_rapids_cmake_dir "cudf")
if [[ -n "${CUDF_BUILD_DIR}" ]]; then
    echo "Found cudf build at: ${CUDF_BUILD_DIR}"
    EXTRA_CMAKE_FLAGS+=" -Dcudf_ROOT=${CUDF_BUILD_DIR}"
fi

# Check for rmm
RMM_BUILD_DIR=$(get_rapids_cmake_dir "rmm")
if [[ -n "${RMM_BUILD_DIR}" ]]; then
    echo "Found rmm build at: ${RMM_BUILD_DIR}"
    EXTRA_CMAKE_FLAGS+=" -Drmm_ROOT=${RMM_BUILD_DIR}"
fi

# Check for kvikio
KVIKIO_BUILD_DIR=$(get_rapids_cmake_dir "kvikio")
if [[ -n "${KVIKIO_BUILD_DIR}" ]]; then
    echo "Found kvikio build at: ${KVIKIO_BUILD_DIR}"
    EXTRA_CMAKE_FLAGS+=" -Dkvikio_ROOT=${KVIKIO_BUILD_DIR}"
fi

echo ""

make cmake BUILD_DIR="${BUILD_TYPE}" BUILD_TYPE="${BUILD_TYPE}" \
    EXTRA_CMAKE_FLAGS="${EXTRA_CMAKE_FLAGS}" BUILD_BASE_DIR="${BUILD_BASE_DIR}"

echo ""
echo "=== Configuration complete ==="
echo "Build directory: ${BUILD_BASE_DIR}/${BUILD_TYPE}"
echo ""
echo "To build, run: build-velox --${BUILD_TYPE}"
