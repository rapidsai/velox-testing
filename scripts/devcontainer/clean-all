#!/bin/bash
# Clean everything: RAPIDS libraries, velox, and presto.
# Wraps the RAPIDS clean-all and adds clean-velox + clean-presto.
#
# Common arguments are forwarded to the RAPIDS clean-all.
# --release/--debug are forwarded to clean-velox.
# clean-presto always cleans everything.

set -euo pipefail

usage() {
    cat <<EOF
Usage: clean-all [OPTIONS]

Clean RAPIDS libraries, velox, and presto-native-execution build artifacts.

Options:
  --release                     Clean release builds only (velox)
  --debug                       Clean debug builds only (velox)
  -j, --parallel N              Clean N RAPIDS repos in parallel
  -v, --verbose                 Verbose output
  -h, --help                    Show this help message

All other options are forwarded to the RAPIDS clean-all.
EOF
}

BUILD_TYPE=""
RAPIDS_ARGS=()
VELOX_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage; exit 0 ;;
        --release)
            BUILD_TYPE="release"
            VELOX_ARGS+=("--release")
            shift
            ;;
        --debug)
            BUILD_TYPE="debug"
            VELOX_ARGS+=("--debug")
            shift
            ;;
        -j|--parallel)
            RAPIDS_ARGS+=("-j" "$2")
            shift 2
            ;;
        -v|--verbose)
            RAPIDS_ARGS+=("-v")
            shift
            ;;
        *)
            RAPIDS_ARGS+=("$1")
            shift
            ;;
    esac
done

if [[ -x /usr/bin/clean-all ]]; then
    /usr/bin/clean-all "${RAPIDS_ARGS[@]+"${RAPIDS_ARGS[@]}"}"
fi

clean-velox "${VELOX_ARGS[@]+"${VELOX_ARGS[@]}"}"
clean-presto
