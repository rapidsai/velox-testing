services:
  presto-coordinator:
    container_name: presto-coordinator
    image: prestodb/presto:latest
    ports:
      - 8080:8080
    volumes:
      - ./config/etc_common:/opt/presto-server/etc
      - ./config/etc_coordinator/config_native.properties:/opt/presto-server/etc/config.properties
      - ./config/etc_coordinator/node.properties:/opt/presto-server/etc/node.properties
      # Host mounts for TPCH Parquet data and file-metastore persistence
      # Support both traditional (/base/sf1) and scale-specific (/base_sf1) layouts
      - ${TPCH_PARQUET_DIR:-./data/tpch}:/data/tpch:ro
      - ${TPCH_PARQUET_SF1_DIR:-/raid/pwilson/parquet_sf1}:/data/tpch_sf1:ro
      - ${TPCH_PARQUET_SF10_DIR:-/raid/pwilson/parquet_sf10}:/data/tpch_sf10:ro
      - ${TPCH_PARQUET_SF100_DIR:-/raid/pwilson/parquet_sf100}:/data/tpch_sf100:ro
      - ${HIVE_METASTORE_DIR:-./data/hive-metastore}:/data/hive-metastore
  presto-native-worker-gpu:
    container_name: presto-native-worker-gpu
    image: presto-native-worker-gpu:latest
    # build:
    #   context: ../../..
    #   dockerfile: velox-testing/presto/docker/native_build.dockerfile
    #   args:
    #     GPU: ON
    # Use NVIDIA Container Toolkit runtime if available
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - RMM_LOGGING_LEVEL=ERROR
      - RMM_POOL_SIZE=26G
      - RMM_LOG_FILE=/tmp/rmm.log
      - GLOG_logtostderr=1
    volumes:
      - ./config/etc_common/catalog:/opt/presto-server/etc/catalog
      - ./config/etc_common/jvm.config:/opt/presto-server/etc/jvm.config
      - ./config/etc_common/log.properties:/opt/presto-server/etc/log.properties
      - ./config/etc_worker/config_native.properties:/opt/presto-server/etc/config.properties
      - ./config/etc_worker/node.properties:/opt/presto-server/etc/node.properties
      # Same mounts on worker for consistency
      # Support both traditional (/base/sf1) and scale-specific (/base_sf1) layouts
      - ${TPCH_PARQUET_DIR:-./data/tpch}:/data/tpch:ro
      - ${TPCH_PARQUET_SF1_DIR:-/raid/pwilson/parquet_sf1}:/data/tpch_sf1:ro
      - ${TPCH_PARQUET_SF10_DIR:-/raid/pwilson/parquet_sf10}:/data/tpch_sf10:ro
      - ${TPCH_PARQUET_SF100_DIR:-/raid/pwilson/parquet_sf100}:/data/tpch_sf100:ro
      - ${HIVE_METASTORE_DIR:-./data/hive-metastore}:/data/hive-metastore
    depends_on:
      - presto-coordinator
