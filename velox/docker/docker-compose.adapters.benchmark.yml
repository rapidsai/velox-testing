services:
  velox-benchmark:
    container_name: velox-benchmark
    image: velox-adapters-build:latest
    runtime: ${DOCKER_RUNTIME:-nvidia}
    environment:
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
    volumes:
      - ../../../velox:/workspace/velox
      - ${BENCHMARK_DATA_HOST_PATH:-/tmp}:/workspace/velox/velox-benchmark-data:ro
      - ${BENCHMARK_RESULTS_HOST_PATH:-./benchmark_results}:/workspace/velox/benchmark_results
    working_dir: /workspace/velox

  velox-asv-benchmark:
    container_name: velox-asv-benchmark
    image: velox-asv-benchmark:latest
    # Build configuration (used by build_asv_image.sh)
    build:
      context: ../../..
      dockerfile: velox-testing/velox/asv_benchmarks/Dockerfile
      args:
        BUILD_BASE_DIR: ${BUILD_BASE_DIR:-/opt/velox-build}
        BUILD_TYPE: ${BUILD_TYPE:-release}
        TPCH_DATA_PATH: /workspace/velox/velox-benchmark-data
    # Runtime configuration (used by run_asv_benchmarks.sh)
    # Note: These variables must be set even during build for docker-compose validation
    runtime: ${DOCKER_RUNTIME:-nvidia}
    environment:
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      - TPCH_DATA_PATH=/workspace/velox/velox-benchmark-data
      - LD_LIBRARY_PATH=/opt/velox-build/release/velox/experimental/cudf/benchmarks/python/cpp/tpch:/usr/local/cuda/lib64:${LD_LIBRARY_PATH:-}
      - ASV_BENCH=${ASV_BENCH:-}
      - ASV_MACHINE=${ASV_MACHINE:-docker-container}
      - ASV_CLEAR_RESULTS=${ASV_CLEAR_RESULTS:-false}
      - ASV_SKIP_EXISTING=${ASV_SKIP_EXISTING:-false}
      - ASV_SKIP_AUTORUN=${ASV_SKIP_AUTORUN:-false}
      - ASV_SKIP_SMOKE_TEST=${ASV_SKIP_SMOKE_TEST:-false}
      - ASV_PREVIEW=${ASV_PREVIEW:-true}
      - ASV_RECORD_SAMPLES=${ASV_RECORD_SAMPLES:-false}
      - ASV_APPEND_SAMPLES=${ASV_APPEND_SAMPLES:-false}
      - ASV_AUTO_MACHINE=${ASV_AUTO_MACHINE:-false}
      - ASV_PREVIEW_EXISTING=${ASV_PREVIEW_EXISTING:-false}
      - ASV_PUBLISH_PREVIEW_EXISTING=${ASV_PUBLISH_PREVIEW_EXISTING:-false}
      - ASV_PORT=${ASV_PORT:-8080}
      - ASV_COMMIT_RANGE=${ASV_COMMIT_RANGE:-}
      - ASV_ENV_TYPE=${ASV_ENV_TYPE:-virtualenv}
    volumes:
      - ../../../velox:/workspace/velox
      - ../../../velox-testing/velox/asv_benchmarks:/workspace/velox-testing/velox/asv_benchmarks
      - ../../../velox-testing/velox/asv_benchmarks/asv.conf.json:/workspace/velox-testing/velox/asv_benchmarks/asv.conf.json:ro
      - ../../../velox-testing/velox/asv_benchmarks/entrypoint.sh:/entrypoint.sh:ro
      - ${BENCHMARK_DATA_HOST_PATH:-/tmp}:/workspace/velox/velox-benchmark-data:ro
      # Mount ASV results directory separately for easy management and cleanup
      - ${ASV_RESULTS_HOST_PATH:-../asv_benchmarks/results}:/asv_results:rw
    ports:
      - "${ASV_PORT:-8080}:${ASV_PORT:-8080}"
    working_dir: /workspace/velox-testing/velox/asv_benchmarks
