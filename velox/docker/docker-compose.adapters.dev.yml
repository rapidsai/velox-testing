services:
  velox-adapters-dev:
    container_name: velox-adapters-dev
    image: velox-adapters-dev:latest
    build:
      context: ../../..
      dockerfile: velox-testing/velox/docker/adapters_dev.dockerfile
    runtime: ${DOCKER_RUNTIME:-nvidia}
    entrypoint: ["/usr/local/bin/hostuser_entrypoint.sh"]
    command: []
    volumes:
      # Source tree 
      - ../../../velox:/workspace/velox:rw
      # sccache caches (persistent volumes to mimic BuildKit cache mounts)
      - velox_sccache_preprocessor:/root/.cache/sccache/preprocessor
      - velox_sccache_dist_client:/root/.cache/sccache-dist-client
      # sccache setup script (read-only bind) (may not be used)
      - ./sccache/sccache_setup.sh:/sccache_setup.sh:ro
      # mount build script
      - ../scripts/velox_dev_build.sh:/velox_dev_build.sh:ro
      # ccls bootstrap
      - ../scripts/ccls_bootstrap.sh:/usr/local/bin/ccls_bootstrap.sh:ro
      # entrypoint to create user + sudo
      - ../scripts/hostuser_entrypoint.sh:/usr/local/bin/hostuser_entrypoint.sh:ro
    working_dir: /workspace/velox
    environment:
      HOST_UID: ${HOST_UID:-0}
      HOST_GID: ${HOST_GID:-0}
      HOST_USER: ${HOST_USER:-hostuser}
      HOST_HOME: ${HOST_HOME:-/home/hostuser}
      HOST_VELOX_ABS: ${HOST_VELOX_ABS:-/workspace/velox}
      BUILD_BASE_DIR: ${BUILD_BASE_DIR:-/workspace/velox/velox-build}
      ENABLE_CCLS: ${ENABLE_CCLS:-true}
volumes:
  velox_sccache_preprocessor:
  velox_sccache_dist_client:
